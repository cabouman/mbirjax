### This script is for reconstructing cone beam CT data from Purdue Zeiss scanner

import os
import sys
import numpy as np
import jax.numpy as jnp
import pprint
import mbirjax as mj
import mbirjax.preprocess as mjp

pp = pprint.PrettyPrinter(indent=4)

def main():
    # Recon parameters
    sharpness = 1.0
    downsample_factor = 2
    subsample_view_factor = 2
    ROR_scale = 1.2

    # Path to the dataset
    dataset_dir = '/depot/bouman/data/Zeiss/purdue/Scan_tomo-A.txrm'
    recon_dir = '/depot/bouman/data/Zeiss/purdue/Scan_tomo-A_recon.txm'

    # Output path
    output_path = '/home/yang1581/Data'  # path to store output recon images

    # Load the sinogram and metadata
    print("\n********** Load sinogram and metadata from the data **************")
    sinogram, cone_beam_params, optional_params, metadata = mjp.zeiss_cb.compute_sino_and_params(dataset_dir, downsample_factor=(downsample_factor, downsample_factor),
                                                                                                 subsample_view_factor=subsample_view_factor,
                                                                                                 is_preprocessed=False)

    # Construct cone beam model
    print("\n********** Construct cone beam model **************")
    ct_model = mj.ConeBeamModel(**cone_beam_params)
    ct_model.set_params(**optional_params)

    # Rerun auto-parameter functions because we changed the assumed detector pitch
    ct_model.auto_set_recon_geometry(sinogram.shape) # Reset default recon shape

    # Sharpness and weights
    ct_model.set_params(sharpness=sharpness)
    weights = mj.gen_weights(sinogram, weight_type='transmission_root')

    # Display the sinogram
    mj.slice_viewer(sinogram, slice_axis=0, title='Original sinogram')

    # Scale the region of reconstruction (ROR) to reduce artifacts
    pad_size = ct_model.scale_recon_shape(row_scale=ROR_scale, col_scale=ROR_scale)

    # Print out model parameters
    ct_model.print_params()

    # Perform FDK reconstruction
    print("\n********** Perform FDK reconstruction **************")
    direct_recon = ct_model.direct_recon(sinogram)

    # Perform MBIR reconstruction
    print("\n********** Perform MBIR reconstruction **************")
    mbir_recon, recon_dict = ct_model.recon(sinogram, weights=weights, max_iterations=30)

    # Mask out Region of Interest (ROI)
    radial_margin = max(pad_size[0], pad_size[1]) // 2
    mbir_recon = mjp.apply_cylindrical_mask(mbir_recon, radial_margin=radial_margin, top_margin=0, bottom_margin=0)

    # Save recon to hdf5
    print("\n*********** save mbir and fdk recon in h5 format *************")
    os.makedirs(output_path, exist_ok=True)  # mkdir if directory does not exist
    fdk_path = os.path.join(output_path, f"cone_fdk_recon.h5")
    mj.export_recon_hdf5(fdk_path, direct_recon, recon_dict=None)
    mbir_path = os.path.join(output_path, f"cone_mbir_recon.h5")
    mj.export_recon_hdf5(mbir_path, mbir_recon, recon_dict=None, remove_flash=True)
    print("FDK recon saved to {}".format(os.path.abspath(fdk_path)))
    print("MBIR recon saved to {}".format(os.path.abspath(mbir_path)))

    # Display the results
    mj.slice_viewer(direct_recon, mbir_recon, slice_axis=2,
                    slice_label=['FDK', 'MBIR'],
                    title='Comparison between FDK and MBIR reconstructions')

    # Display the reconstruction generated by Zeiss scanner
    zeiss_recon, _ = mjp.zeiss_cb.read_txrm(recon_dir)
    mj.slice_viewer(zeiss_recon, slice_axis=2, title='Reconstruction generated by Zeiss scanner')

if __name__ == '__main__':
    main()